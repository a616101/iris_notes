# ğŸ‰ API ç«¯é»å¯¦ä½œå®Œæˆå ±å‘Š

## ğŸ“Š å¯¦ä½œç¸½è¦½

**å®Œæˆæ—¥æœŸ**: 2026-01-14  
**å¯¦ä½œç¯„åœ**: æ‰€æœ‰ CRUD API ç«¯é»

---

## âœ… å·²å¯¦ä½œçš„ API ç«¯é»

### å®¢æˆ¶ç®¡ç† API

#### 1. âœ… GET /api/customers
**åŠŸèƒ½**: æŸ¥è©¢å®¢æˆ¶åˆ—è¡¨  
**æª”æ¡ˆ**: `app/api/customers/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- æœå°‹ï¼ˆå…¬å¸åç¨±ã€åœ°å€ã€è¯çµ¡äººã€ç´€éŒ„å…§å®¹ï¼‰
- ç¯©é¸ï¼ˆé¡åˆ¥ã€ç­‰ç´šï¼‰
- æ—¥æœŸç¯©é¸
- å¾…å›è¦†ç¯©é¸
- æˆæ¬Šé©—è­‰

#### 2. âœ… POST /api/customers
**åŠŸèƒ½**: æ–°å¢å®¢æˆ¶  
**æª”æ¡ˆ**: `app/api/customers/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- å»ºç«‹å®¢æˆ¶åŸºæœ¬è³‡æ–™
- åŒæ™‚å»ºç«‹å¤šå€‹è¯çµ¡äºº
- å¯é¸çš„é¦–ç­†é–‹ç™¼ç´€éŒ„
- è‡ªå‹•å»ºç«‹æˆ–æŸ¥æ‰¾é¡åˆ¥
- æˆæ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "company": "å‹•æ„Ÿå¹¼ç¨šåœ’",
  "category": "å­¸æ ¡",
  "phone": "02-1234-5678",
  "address": "æ˜¥æ—¥éƒ¨å¸‚é›™è‘‰ç”º 1-1",
  "level": "L1",
  "otherSales": "A",
  "nextTime": "2024-01-20",
  "contacts": [
    {
      "name": "å‰æ°¸è€å¸«",
      "title": "ä¸»ä»»"
    }
  ],
  "initialLog": {
    "logDate": "2024-01-14",
    "method": "é›»è©±",
    "notes": "é¦–æ¬¡è¯ç¹«ï¼Œå®¢æˆ¶è¡¨ç¤ºæœ‰èˆˆè¶£"
  }
}
```

#### 3. âœ… GET /api/customers/:id
**åŠŸèƒ½**: æŸ¥è©¢å–®ä¸€å®¢æˆ¶  
**æª”æ¡ˆ**: `app/api/customers/[id]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- å®Œæ•´å®¢æˆ¶è³‡æ–™ï¼ˆå«é¡åˆ¥ã€è¯çµ¡äººã€é–‹ç™¼ç´€éŒ„ï¼‰
- æˆæ¬Šé©—è­‰
- æ‰€æœ‰æ¬Šé©—è­‰

#### 4. âœ… PATCH /api/customers/:id
**åŠŸèƒ½**: æ›´æ–°å®¢æˆ¶è³‡æ–™  
**æª”æ¡ˆ**: `app/api/customers/[id]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- éƒ¨åˆ†æ›´æ–°ï¼ˆåªæ›´æ–°æä¾›çš„æ¬„ä½ï¼‰
- é¡åˆ¥è‡ªå‹•å»ºç«‹æˆ–æŸ¥æ‰¾
- æˆæ¬Šé©—è­‰
- æ‰€æœ‰æ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "level": "L5",
  "nextTime": "2024-01-25"
}
```

#### 5. âœ… DELETE /api/customers/:id
**åŠŸèƒ½**: åˆªé™¤å®¢æˆ¶  
**æª”æ¡ˆ**: `app/api/customers/[id]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- ç´šè¯åˆªé™¤ï¼ˆè‡ªå‹•åˆªé™¤é—œè¯çš„è¯çµ¡äººå’Œé–‹ç™¼ç´€éŒ„ï¼‰
- æˆæ¬Šé©—è­‰
- æ‰€æœ‰æ¬Šé©—è­‰

---

### è¯çµ¡äººç®¡ç† API

#### 6. âœ… POST /api/customers/:id/contacts
**åŠŸèƒ½**: æ–°å¢è¯çµ¡äºº  
**æª”æ¡ˆ**: `app/api/customers/[id]/contacts/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- æ–°å¢è¯çµ¡äººåˆ°æŒ‡å®šå®¢æˆ¶
- å¿…å¡«é©—è­‰
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶æ‰€æœ‰æ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "name": "ç”°ä¸­å…ˆç”Ÿ",
  "title": "å‰¯ä¸»ä»»"
}
```

#### 7. âœ… PATCH /api/customers/:id/contacts/:contactId
**åŠŸèƒ½**: æ›´æ–°è¯çµ¡äºº  
**æª”æ¡ˆ**: `app/api/customers/[id]/contacts/[contactId]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- æ›´æ–°è¯çµ¡äººè³‡è¨Š
- å¿…å¡«é©—è­‰
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶å’Œè¯çµ¡äººæ‰€æœ‰æ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "name": "ç”°ä¸­å…ˆç”Ÿ",
  "title": "ä¸»ä»»"
}
```

#### 8. âœ… DELETE /api/customers/:id/contacts/:contactId
**åŠŸèƒ½**: åˆªé™¤è¯çµ¡äºº  
**æª”æ¡ˆ**: `app/api/customers/[id]/contacts/[contactId]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- åˆªé™¤æŒ‡å®šè¯çµ¡äºº
- é˜²æ­¢åˆªé™¤æœ€å¾Œä¸€å€‹è¯çµ¡äºº
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶å’Œè¯çµ¡äººæ‰€æœ‰æ¬Šé©—è­‰

**éŒ¯èª¤å›æ‡‰**:
```json
{
  "error": "ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å€‹è¯çµ¡äººï¼Œæ¯å€‹å®¢æˆ¶è‡³å°‘éœ€è¦ä¸€å€‹è¯çµ¡äºº"
}
```

---

### é–‹ç™¼ç´€éŒ„ç®¡ç† API

#### 9. âœ… POST /api/customers/:id/logs
**åŠŸèƒ½**: æ–°å¢é–‹ç™¼ç´€éŒ„  
**æª”æ¡ˆ**: `app/api/customers/[id]/logs/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- æ–°å¢é–‹ç™¼ç´€éŒ„åˆ°æŒ‡å®šå®¢æˆ¶
- å¿…å¡«é©—è­‰
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶æ‰€æœ‰æ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "logDate": "2024-01-14",
  "method": "é›»è©±",
  "notes": "å®¢æˆ¶è¡¨ç¤ºå°ç”¢å“æœ‰èˆˆè¶£ï¼Œç´„ä¸‹é€±ä¸‰é€²è¡Œç°¡å ±"
}
```

#### 10. âœ… PATCH /api/customers/:id/logs/:logId
**åŠŸèƒ½**: æ›´æ–°é–‹ç™¼ç´€éŒ„  
**æª”æ¡ˆ**: `app/api/customers/[id]/logs/[logId]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- æ›´æ–°é–‹ç™¼ç´€éŒ„å…§å®¹
- å¿…å¡«é©—è­‰
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶å’Œç´€éŒ„æ‰€æœ‰æ¬Šé©—è­‰

**è«‹æ±‚ç¯„ä¾‹**:
```json
{
  "logDate": "2024-01-14",
  "method": "LINE",
  "notes": "å®¢æˆ¶è¡¨ç¤ºå°ç”¢å“éå¸¸æœ‰èˆˆè¶£ï¼Œå·²ç¢ºèªä¸‹é€±ä¸‰é€²è¡Œç°¡å ±"
}
```

#### 11. âœ… DELETE /api/customers/:id/logs/:logId
**åŠŸèƒ½**: åˆªé™¤é–‹ç™¼ç´€éŒ„  
**æª”æ¡ˆ**: `app/api/customers/[id]/logs/[logId]/route.ts`  
**æ”¯æ´åŠŸèƒ½**:
- åˆªé™¤æŒ‡å®šé–‹ç™¼ç´€éŒ„
- æˆæ¬Šé©—è­‰
- å®¢æˆ¶å’Œç´€éŒ„æ‰€æœ‰æ¬Šé©—è­‰

---

## ğŸ”’ å®‰å…¨æ€§ç‰¹é»

### æˆæ¬Šé©—è­‰
æ‰€æœ‰ API ç«¯é»éƒ½å¯¦ä½œäº† NextAuth.js æˆæ¬Šé©—è­‰ï¼š
```typescript
const session = await getServerSession(authOptions);
if (!session?.user?.id) {
  return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
}
```

### æ‰€æœ‰æ¬Šé©—è­‰
æ‰€æœ‰è³‡æ–™æ“ä½œéƒ½æœƒé©—è­‰è³‡æºæ˜¯å¦å±¬æ–¼ç•¶å‰ä½¿ç”¨è€…ï¼š
```typescript
const customer = await prisma.customer.findFirst({
  where: {
    id: parseInt(params.id),
    userId: parseInt(session.user.id),
  },
});

if (!customer) {
  return NextResponse.json({ error: 'å®¢æˆ¶ä¸å­˜åœ¨' }, { status: 404 });
}
```

### è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
- âœ… é˜²æ­¢åˆªé™¤æœ€å¾Œä¸€å€‹è¯çµ¡äºº
- âœ… å¿…å¡«æ¬„ä½é©—è­‰
- âœ… æ—¥æœŸæ ¼å¼è™•ç†
- âœ… Null å€¼æ­£ç¢ºè™•ç†

---

## ğŸ“ API å›æ‡‰æ ¼å¼

### æˆåŠŸå›æ‡‰
```json
{
  "id": 1,
  "company": "å‹•æ„Ÿå¹¼ç¨šåœ’",
  "category": {
    "id": 1,
    "name": "å­¸æ ¡"
  },
  "contacts": [...],
  "logs": [...]
}
```

### éŒ¯èª¤å›æ‡‰
```json
{
  "error": "éŒ¯èª¤è¨Šæ¯"
}
```

### HTTP ç‹€æ…‹ç¢¼
- `200` - æˆåŠŸ
- `201` - å»ºç«‹æˆåŠŸ
- `400` - è«‹æ±‚éŒ¯èª¤ï¼ˆé©—è­‰å¤±æ•—ï¼‰
- `401` - æœªæˆæ¬Š
- `404` - è³‡æºä¸å­˜åœ¨
- `500` - ä¼ºæœå™¨éŒ¯èª¤

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. æˆæ¬Šæ¸¬è©¦
```bash
# æœªç™»å…¥æ‡‰è¿”å› 401
curl -X GET http://localhost:3000/api/customers

# ç™»å…¥å¾Œæ‡‰è¿”å›è³‡æ–™
curl -X GET http://localhost:3000/api/customers \
  -H "Cookie: next-auth.session-token=..."
```

### 2. CRUD åŠŸèƒ½æ¸¬è©¦
```bash
# æ–°å¢å®¢æˆ¶
curl -X POST http://localhost:3000/api/customers \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=..." \
  -d '{...}'

# æ›´æ–°å®¢æˆ¶
curl -X PATCH http://localhost:3000/api/customers/1 \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=..." \
  -d '{"level": "L5"}'

# åˆªé™¤å®¢æˆ¶
curl -X DELETE http://localhost:3000/api/customers/1 \
  -H "Cookie: next-auth.session-token=..."
```

### 3. é‚Šç•Œæ¢ä»¶æ¸¬è©¦
- âœ… åˆªé™¤æœ€å¾Œä¸€å€‹è¯çµ¡äººï¼ˆæ‡‰è¿”å› 400 éŒ¯èª¤ï¼‰
- âœ… è¨ªå•ä¸å±¬æ–¼è‡ªå·±çš„å®¢æˆ¶ï¼ˆæ‡‰è¿”å› 404ï¼‰
- âœ… ç¼ºå°‘å¿…å¡«æ¬„ä½ï¼ˆæ‡‰è¿”å› 400 éŒ¯èª¤ï¼‰

---

## ğŸ¯ å·²å¯¦ç¾çš„åŠŸèƒ½ç‰¹æ€§

### éƒ¨åˆ†æ›´æ–°æ”¯æ´
`PATCH /api/customers/:id` æ”¯æ´éƒ¨åˆ†æ›´æ–°ï¼Œåªæ›´æ–°æä¾›çš„æ¬„ä½ï¼š
```typescript
const updateData: any = {};
if (company !== undefined) updateData.company = company;
if (level !== undefined) updateData.level = level;
// ... å…¶ä»–æ¬„ä½
```

### ç´šè¯æ“ä½œ
- åˆªé™¤å®¢æˆ¶æ™‚è‡ªå‹•åˆªé™¤ç›¸é—œè¯çµ¡äººå’Œé–‹ç™¼ç´€éŒ„
- æ–°å¢å®¢æˆ¶æ™‚å¯åŒæ™‚å»ºç«‹è¯çµ¡äººå’Œé¦–ç­†ç´€éŒ„

### è‡ªå‹•é¡åˆ¥ç®¡ç†
ç³»çµ±æœƒè‡ªå‹•æŸ¥æ‰¾æˆ–å»ºç«‹é¡åˆ¥ï¼Œç„¡éœ€æ‰‹å‹•ç®¡ç†é¡åˆ¥ IDï¼š
```typescript
let categoryRecord = await prisma.category.findUnique({
  where: { name: category },
});

if (!categoryRecord) {
  categoryRecord = await prisma.category.create({
    data: { name: category },
  });
}
```

### éŒ¯èª¤è™•ç†
æ‰€æœ‰ç«¯é»éƒ½åŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„ï¼š
```typescript
try {
  // ... æ“ä½œ
} catch (error) {
  console.error('æ“ä½œéŒ¯èª¤:', error);
  return NextResponse.json({ error: 'ä¼ºæœå™¨éŒ¯èª¤' }, { status: 500 });
}
```

---

## ğŸ“Š API ç«¯é»ç¸½è¦½è¡¨

| æ–¹æ³• | è·¯å¾‘ | åŠŸèƒ½ | ç‹€æ…‹ |
|------|------|------|------|
| GET | /api/customers | æŸ¥è©¢å®¢æˆ¶åˆ—è¡¨ | âœ… |
| POST | /api/customers | æ–°å¢å®¢æˆ¶ | âœ… |
| GET | /api/customers/:id | æŸ¥è©¢å–®ä¸€å®¢æˆ¶ | âœ… |
| PATCH | /api/customers/:id | æ›´æ–°å®¢æˆ¶ | âœ… |
| DELETE | /api/customers/:id | åˆªé™¤å®¢æˆ¶ | âœ… |
| POST | /api/customers/:id/contacts | æ–°å¢è¯çµ¡äºº | âœ… |
| PATCH | /api/customers/:id/contacts/:contactId | æ›´æ–°è¯çµ¡äºº | âœ… |
| DELETE | /api/customers/:id/contacts/:contactId | åˆªé™¤è¯çµ¡äºº | âœ… |
| POST | /api/customers/:id/logs | æ–°å¢é–‹ç™¼ç´€éŒ„ | âœ… |
| PATCH | /api/customers/:id/logs/:logId | æ›´æ–°é–‹ç™¼ç´€éŒ„ | âœ… |
| DELETE | /api/customers/:id/logs/:logId | åˆªé™¤é–‹ç™¼ç´€éŒ„ | âœ… |

---

## ğŸ‰ ç¸½çµ

**æ‰€æœ‰ 11 å€‹ API ç«¯é»å·²å…¨éƒ¨å¯¦ä½œå®Œæˆï¼**

ç³»çµ±ç¾åœ¨æ“æœ‰ï¼š
- âœ… å®Œæ•´çš„ CRUD API ç«¯é»
- âœ… åš´æ ¼çš„æˆæ¬Šå’Œæ‰€æœ‰æ¬Šé©—è­‰
- âœ… å®Œå–„çš„éŒ¯èª¤è™•ç†
- âœ… è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
- âœ… éƒ¨åˆ†æ›´æ–°æ”¯æ´
- âœ… ç´šè¯æ“ä½œ
- âœ… è‡ªå‹•é¡åˆ¥ç®¡ç†

**å‰ç«¯ UI/UX + å¾Œç«¯ API = å®Œæ•´å¯ç”¨çš„ CRM ç³»çµ±ï¼** ğŸš€

---

**å¯¦ä½œå®Œæˆæ—¥æœŸ**: 2026-01-14  
**å¯¦ä½œè€…**: Claude (Anthropic)  
**å°ˆæ¡ˆç‹€æ…‹**: âœ… å®Œæ•´å¯¦ä½œå®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”¨
